pipeline:
  npm:preview:
    image: node:19.6-bullseye
    environment:
      NODE_ENV: "production"
    commands:
      - corepack enable
      - pnpm install --frozen-lockfile
      - pnpm task dev:build
      - pnpm task dev:test
    when:
      event:
        - push
        - tag
      tag: v*
      branch:
        - release/*

  npm:official:
    image: node:19.6-bullseye
    secrets: [npm_api_token, github_api_token]
    environment:
      NODE_ENV: "production"
    commands:
      - corepack enable
      - pnpm task dev:changeset:status
      # Publish to GitHub Packages
      - echo '//npm.pkg.github.com/:_authToken=${GITHUB_API_TOKEN}' >> $HOME/.npmrc
      - pnpm task dev:changeset:publish
      - rm $HOME/.npmrc
      # Publish to NPM
      # - echo '//registry.npmjs.org/:_authToken=${NPM_API_TOKEN}' >> $HOME/.npmrc
      # - pnpm task dev:changeset:publish
      # - rm $HOME/.npmrc
    when:
      event:
        - tag
      tag: v*
