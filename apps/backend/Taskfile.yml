version: 3

tasks:
  # Run dependencies as cmds so they run sequentially (it's slower this way but otherwise output is unreadable)
  build-dependencies:
    cmds:
      - task: :docker:base:build
      - tasK: :docker:prod:build

  build:
    desc: "Build backend image for production use"
    deps:
      - build-dependencies
    cmds:
      - "docker build -t doseofted/prim-backend ."

  prod:
    desc: "Run backend image in production mode"
    deps:
      - build
    cmds:
      - "docker run -it --rm doseofted/prim-backend {{.CLI_ARGS}}"

  dev:
    desc: "Build and run backend image targeting \"dev\" stage with src folder mounted to host"
    deps:
      - build-dependencies
    cmds:
      - "docker build -t doseofted/prim-backend-dev --target=dev ."
      - |
        docker run -it --rm \
          -v "$(pwd)/src:/home/node/project/apps/backend/src" \
          -p 3001:3001 \
          doseofted/prim-backend-dev {{.CLI_ARGS}}
