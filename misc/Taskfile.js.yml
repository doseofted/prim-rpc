# yaml-language-server: https://json.schemastore.org/taskfile.json
version: "3"

tasks:

  # SECTION: "setup" task steps
  install:
    cmds:
     - "pnpm install"
    sources:
      - "package.json"
      - "pnpm-*.yaml"
    generates:
      - "node_modules/**/*"

  test:
    desc: "Build libraries and then test with Jest."
    cmds:
      - "pnpm libraries:test"

  build:libraries:
    cmds:
      - "pnpm libraries:build"
    sources:
      - "libraries/packages/**/src/**/*"
    generates:
      - "libraries/packages/**/dist/**/*"

  build:frontend:
    env:
      VITE_HOST: "{{.HOST}}"
    cmds:
      - "pnpm frontend build"
    sources:
      - "project/frontend/src/**/*"
      - "project/frontend/public/**/*"
    generates:
      - "project/frontend/dist/**/*"

  build:backend:
    cmds:
      - "pnpm backend build"
    sources:
      - "project/backend/src/**/*"
    generates:
      - "project/backend/dist/**/*"
  # !SECTION: "setup" task steps

  # this task, like many other "js:"" tasks only apply to development since project is run through containers in production
  setup:
    desc: "Install dependencies and build all projects once, mostly for use of type definitions in code editor"
    env:
      NODE_ENV: "development"
    cmds:
      - task: "install"
      - task: "build:libraries"
      - task: "build:frontend"
      - task: "build:backend"

  # Since this is a task that can't be run in containers, it should be built in production mode
  sync:
    desc: "Build the frontend locally and sync to all available native platforms"
    env:
      # FIXME: npm install has to be in development mode because Electron dependencies are missing in production mode
      NODE_ENV: "development"
    sources:
      - "project/frontend/dist/**/*"
    generates:
      - "project/frontend/ios/**/*"
      - "project/frontend/android/**/*"
      - "project/frontend/electron/**/*"
    deps:
      # First build the frontend
      - "build:frontend"
    cmds:
      # Next sync the built frontend on Android and iOS
      - "pnpm frontend cap sync"
      # Now install Electron dependencies before syncing with Electron
      - "pnpm frontend sync:electroninstall"
      # Sync with Electron (not included in "cap sync" since it is a community-maintained platform)
      - "pnpm frontend sync:electron"

  start:
    desc: "Run built frontend on given platform (ios, android, or desktop), like so: `task js:start -- desktop`"
    deps:
      - sync
    cmds:
      - "pnpm frontend {{.CLI_ARGS}}"

  watch:libraries:
    interactive: true
    cmds:
      - "pnpm libraries:dev"

  watch:backend:
    interactive: true
    cmds:
      - "pnpm backend dev"

  watch:frontend:
    interactive: true
    cmds:
      - "pnpm frontend dev"

  # TODO: make this work locally (currently only works in containers)
  # for instance, variables need to be assigned and strict security settings disabled since not running behind Caddy
  # I could also prevent some tasks from running if not needed: https://taskfile.dev/#/usage?id=prevent-unnecessary-work
  # watch:
  #   desc: "Build and watch all JS-related projects, with server running"
  #   deps:
  #     - watch:libraries
  #     - watch:frontend
  #     - watch:backend
